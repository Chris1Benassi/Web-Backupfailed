---
import Layout from '../layouts/Layout.astro';
import ContextAlert from '../components/ContextAlert.astro';

const currentYear = new Date().getFullYear(); // Dynamically get the current year
const faqItems = [
    {
        question: 'Who qualifies for free support?',
        answer: 'We prioritize low or no‑cost help for mission‑driven nonprofits without reliable operational IT. Registered nonprofits (501(c)(3) or equivalent) running ongoing community programs are fastest to qualify; we review requests case‑by‑case and focus pro‑bono capacity on measurable impact.'
    },
    {
        question: 'What if I’m not a nonprofit?',
        answer: 'We work with businesses of all sizes. For paid work we offer hourly support, fixed‑price projects, managed plans, and co‑managed services where we partner with your team or existing provider. You’ll get a clear scope, deliverables, and price up front.'
    },
    {
        question: 'How do I submit a request?',
        answer: 'Use the contact form and include: organization name, whether you’re a nonprofit or business, a short problem description, and any timeline constraints. We triage requests and reply with next steps or a short intake checklist.'
    },
    {
        question: 'Do you offer training or workshops?',
        answer: 'We provide hands‑on, project‑based training as part of engagements (for example: admin handovers, staff onboarding, or operational runbooks). For standalone team training we offer short, paid sessions tailored to your needs, please tell us the outcomes you want and we’ll propose an option.'
    },
    {
        question: 'Privacy & Data handling',
        answer: 'Please see our Privacy Policy for full details on how we collect, store, and protect data.'
    },
    {
        question: 'What technologies do you support?',
        answer: 'Common areas: Microsoft 365, Azure, WordPress/Ghost, basic web work, networking, endpoint security, and automation scripting. We assist with compliance controls (HIPAA/PCI/CJIS) and will recommend partners for large product builds.'
    },
    {
        question: 'I’m not very technical — can you still help me?',
        answer: 'Yes. We act as your technical team when needed: we do the hands‑on work, explain choices in plain language, and leave clear documentation so your staff can manage day‑to‑day tasks later.'
    },
    {
        question: 'Do you provide on‑site visits or only remote support?',
        answer: 'We focus on remote support for speed and cost‑efficiency. On‑site visits are available for local clients or scoped projects and may include travel or site‑visit fees; we’ll confirm logistics and cost in the intake.'
    },
    {
        question: 'What if I already have an IT provider?',
        answer: 'Nonprofits with existing IT coverage are lower priority for pro‑bono help. For paid engagements we can collaborate with or complement your current provider — audits, gap fixes, co‑managed services, or short projects are common. Tell us what you need and we’ll recommend the best path.'
    },
    {
        question: 'How long until you respond?',
        answer: 'We typically reply within 1 business day. If your request is time‑sensitive, mark it as urgent in the form and include the best way to reach you; we’ll prioritize urgent requests when possible.'
    },
    {
        question: 'Do you handle emergencies?',
        answer: 'Yes. For emergencies, calling us is the fastest option we’ll triage immediately and, subject to availability, work to squeeze critical incidents in. Emergency work may be handled as a prioritized paid engagement; we’ll confirm scope and next steps when we respond.'
    }
];
---

<Layout title="Contact Us | Backup Failed Foundation">
    <ContextAlert class="mb-8" />

    <main class="max-w-3xl mx-auto mt-7 px-6 py-12">
        <!-- Contact Form -->
        <form id="contactForm" class="bg-sky-900 text-white p-6 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold mb-6 text-center">Contact Us</h1>

            <label for="name" class="block font-semibold mb-2">Name</label>
            <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full p-3 mb-4 bg-blue-200 text-black border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />

            <label for="email" class="block font-semibold mb-2">Email</label>
            <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full p-3 mb-4 bg-blue-200 text-black border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />

            <label for="topic" class="block font-semibold mb-2">What do you need help with?</label>
            <select
                id="topic"
                name="topic"
                required
                class="w-full p-3 mb-4 bg-blue-200 text-black border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                <option value="Nonprofit IT Consultation">Nonprofit IT Consultation</option>
                <option value="IT Consultation">General Consultation</option>
                <option value="Nonprofit Grant and Cloud Guidance">Nonprofit Grant and Cloud Guidance</option>
                <option value="Managed IT Support">Managed IT Support</option>
                <option value="Domain Support">Domain Support</option>
                <option value="Email Migration Support">Email Migration Support</option>
                <option value="Microsoft or Google Workspace Questions">Microsoft or Google Workspace Questions</option>
                <option value="Endpoint Security">Endpoint Security</option>
                <option value="Website Management">Website Management</option>
                <option value="Custom Automations">Custom Automations</option>
            </select>

            <label for="message" class="block font-semibold mb-2">Message</label>
            <textarea
                id="message"
                name="message"
                required
                class="w-full p-3 mb-4 bg-blue-200 text-black border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>

            <label for="phone" class="block font-semibold mb-2">Phone (optional)</label>
            <input
                type="tel"
                id="phone"
                name="phone"
                placeholder="e.g. +1 555-555-0100"
                class="w-full p-3 mb-1 bg-blue-200 text-black border border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <div class="text-xs text-blue-100/80 mb-4">
                If you enter your phone number, you agree to receive service‑related texts or calls about your request. Message/data rates may apply. Reply STOP
                to opt out at any time.
            </div>

            <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition duration-200"> Send Message </button>
            <div class="mt-3 text-xs text-blue-100/90">
                By submitting this form, you consent to Backup Failed Foundation contacting you about your request, which may include service‑related text
                messages. No marketing texts. Message/data rates may apply. Reply STOP to opt out.
            </div>
            <div id="formMsg" class="mt-4 text-center text-sm"></div>
        </form>

        <!-- Transient toast for errors (appears top-center, vanishes) -->
        <div
            id="toast"
            role="alert"
            aria-live="assertive"
            class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none opacity-0 transition-opacity duration-300"
        >
            <div id="toastInner" class="bg-red-600 text-white px-4 py-2 rounded shadow-lg text-sm"></div>
        </div>

        <div class="my-8 flex items-center gap-4 bg-blue-100 border border-blue-300 rounded-lg p-4 text-blue-900 shadow-sm">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6 text-blue-500 flex-shrink-0"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
                ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm0 12a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2zm12-12a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zm0 12a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                ></path></svg
            >
            <div>
                <span class="font-semibold">Prefer to call?</span>
                <a href="tel:8059004505" class="text-blue-700 font-bold hover:underline ml-1">805-900-4505</a>
                <div class="text-xs text-blue-700/70 mt-1">
                    If I miss your call, please leave a voicemail—I check messages regularly and will get back to you as soon as possible.
                </div>
            </div>
        </div>

        <!-- FAQ Section -->
        <section id="faq" class="faq bg-sky-900 text-white my-8 p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center">Frequently Asked Questions</h2>
            {
                faqItems.map((item) => (
                    <details class="mb-4">
                        <summary class="font-semibold cursor-pointer">{item.question}</summary>
                        <p class="mt-2 text-gray-100">{item.answer}</p>
                    </details>
                ))
            }
        </section>
    </main>
</Layout>

<script>
    import type { ActionAPIContext } from 'astro:actions';

    const form = document.getElementById('contactForm') as HTMLFormElement | null;
    const msg = document.getElementById('formMsg') as HTMLElement | null;
    const endpoint = 'https://bff-contact-function.azurewebsites.net/api/ContactUs?';
    const CONSENT_VERSION = 'v1';

    function normalizePhone(input: string) {
        if (!input) return '';
        let s = input.replace(/[()\s.-]/g, '');
        if (/^\+\d{7,15}$/.test(s)) return s;
        const m = s.match(/^1?(\d{10})$/);
        if (m) return '+1' + m[1];
        return s;
    }

    // Transient toast helper (accessible, auto-hide)
    function showToast(message: string, timeout = 4000) {
        const toast = document.getElementById('toast');
        const inner = document.getElementById('toastInner');
        if (!toast || !inner) return;
        inner.textContent = message;
        toast.style.pointerEvents = 'auto';
        toast.classList.remove('opacity-0');
        toast.classList.add('opacity-100');
        // hide after timeout
        setTimeout(() => {
            toast.classList.remove('opacity-100');
            toast.classList.add('opacity-0');
            toast.style.pointerEvents = 'none';
        }, timeout);
    }

    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (msg) msg.textContent = 'Sending…';

            const formData = new FormData(form);
            const rawPhone = formData.get('phone') ? String(formData.get('phone')) : '';
            const phone = normalizePhone(rawPhone);
            if (phone && !/^\+\d{7,15}$/.test(phone)) {
                const err = 'Please enter a valid phone number (e.g. +1 555-555-0100).';
                if (msg) msg.textContent = err;
                showToast(err);
                return;
            }

            const consent_to_sms = !!phone;

            const data = Object.fromEntries(formData as any) as Record<string, any>;
            data.phone = phone;
            data.consent_to_sms = consent_to_sms;
            data.consent_version = CONSENT_VERSION;
            data.consent_timestamp = new Date().toISOString();
            data.consent_source = 'contact_form';

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (msg) {
                    msg.textContent = res.ok ? 'Thanks! We got your message.' : 'Server error. Try again later.';
                }
                if (!res.ok) {
                    const err = 'Server error. Try again later.';
                    showToast(err);
                }
                if (res.ok) form.reset();
            } catch {
                const err = 'Network error. Check your connection.';
                if (msg) msg.textContent = err;
                showToast(err);
            }
        });
    }

    // Check if the URL contains a 'topic' parameter
    const urlParams = new URLSearchParams(window.location.search);
    const topicParam = urlParams.get('topic');
    if (topicParam) {
        const topicSelect = document.getElementById('topic') as HTMLSelectElement | null;
        if (topicSelect) topicSelect.value = topicParam;
    }
</script>
